{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Eiderflw/Desktop/API%20DIAN/EXCEL/nexus-dashboard/lib/history.ts"],"sourcesContent":["import { Creator } from '@/types';\r\n\r\nexport interface HistorySnapshot {\r\n    date: string; // YYYY-MM-DD\r\n    timestamp: number;\r\n    creators: Creator[];\r\n    metrics: {\r\n        totalDiamonds: number;\r\n        totalHours: number;\r\n        activeCreators: number;\r\n    };\r\n}\r\n\r\nexport interface ComparisonResult {\r\n    dateA: string;\r\n    dateB: string;\r\n    newCreators: Creator[];\r\n    lostCreators: Creator[]; // Present in A but not B\r\n    growth: {\r\n        creatorId: string;\r\n        username: string;\r\n        diamondDelta: number;\r\n        hourDelta: number;\r\n    }[];\r\n}\r\n\r\n// Helper to generate a standardized date key\r\nexport const getSnapshotKey = (date: Date = new Date()): string => {\r\n    return date.toISOString().split('T')[0];\r\n};\r\n\r\n// Logic to compare two lists of creators\r\nexport const compareSnapshots = (prev: Creator[], current: Creator[]): ComparisonResult => {\r\n    const prevMap = new Map(prev.map(c => [c.creatorId, c]));\r\n    const currMap = new Map(current.map(c => [c.creatorId, c]));\r\n\r\n    const newCreators = current.filter(c => !prevMap.has(c.creatorId));\r\n    const lostCreators = prev.filter(c => !currMap.has(c.creatorId));\r\n\r\n    const growth = current\r\n        .filter(c => prevMap.has(c.creatorId))\r\n        .map(curr => {\r\n            const prev = prevMap.get(curr.creatorId)!;\r\n            return {\r\n                creatorId: curr.creatorId,\r\n                username: curr.username,\r\n                diamondDelta: curr.diamonds - prev.diamonds,\r\n                hourDelta: curr.liveHours - prev.liveHours\r\n            };\r\n        })\r\n        .sort((a, b) => b.diamondDelta - a.diamondDelta); // Biggest winners first\r\n\r\n    return {\r\n        dateA: 'Previous',\r\n        dateB: 'Current',\r\n        newCreators,\r\n        lostCreators,\r\n        growth\r\n    };\r\n};\r\n"],"names":[],"mappings":";;;;;;AA2BO,MAAM,iBAAiB,CAAC,OAAa,IAAI,MAAM;IAClD,OAAO,KAAK,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;AAC3C;AAGO,MAAM,mBAAmB,CAAC,MAAiB;IAC9C,MAAM,UAAU,IAAI,IAAI,KAAK,GAAG,CAAC,CAAA,IAAK;YAAC,EAAE,SAAS;YAAE;SAAE;IACtD,MAAM,UAAU,IAAI,IAAI,QAAQ,GAAG,CAAC,CAAA,IAAK;YAAC,EAAE,SAAS;YAAE;SAAE;IAEzD,MAAM,cAAc,QAAQ,MAAM,CAAC,CAAA,IAAK,CAAC,QAAQ,GAAG,CAAC,EAAE,SAAS;IAChE,MAAM,eAAe,KAAK,MAAM,CAAC,CAAA,IAAK,CAAC,QAAQ,GAAG,CAAC,EAAE,SAAS;IAE9D,MAAM,SAAS,QACV,MAAM,CAAC,CAAA,IAAK,QAAQ,GAAG,CAAC,EAAE,SAAS,GACnC,GAAG,CAAC,CAAA;QACD,MAAM,OAAO,QAAQ,GAAG,CAAC,KAAK,SAAS;QACvC,OAAO;YACH,WAAW,KAAK,SAAS;YACzB,UAAU,KAAK,QAAQ;YACvB,cAAc,KAAK,QAAQ,GAAG,KAAK,QAAQ;YAC3C,WAAW,KAAK,SAAS,GAAG,KAAK,SAAS;QAC9C;IACJ,GACC,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,YAAY,GAAG,EAAE,YAAY,GAAG,wBAAwB;IAE9E,OAAO;QACH,OAAO;QACP,OAAO;QACP;QACA;QACA;IACJ;AACJ"}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Eiderflw/Desktop/API%20DIAN/EXCEL/nexus-dashboard/app/api/history/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { Creator } from '@/types';\r\nimport { HistorySnapshot, getSnapshotKey } from '@/lib/history';\r\n\r\nconst HISTORY_DIR = path.join(process.cwd(), 'data', 'history');\r\n\r\n// Ensure directory exists\r\nif (!fs.existsSync(HISTORY_DIR)) {\r\n    fs.mkdirSync(HISTORY_DIR, { recursive: true });\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const body = await req.json();\r\n        const { creators, date } = body; // date is optional override\r\n\r\n        if (!creators || !Array.isArray(creators)) {\r\n            return NextResponse.json({ error: 'Invalid data' }, { status: 400 });\r\n        }\r\n\r\n        const snapshotDate = date || getSnapshotKey();\r\n        const filePath = path.join(HISTORY_DIR, `${snapshotDate}.json`);\r\n\r\n        const snapshot: HistorySnapshot = {\r\n            date: snapshotDate,\r\n            timestamp: Date.now(),\r\n            creators: creators as Creator[],\r\n            metrics: {\r\n                totalDiamonds: creators.reduce((sum: number, c: any) => sum + (c.diamonds || 0), 0),\r\n                totalHours: creators.reduce((sum: number, c: any) => sum + (c.liveHours || 0), 0),\r\n                activeCreators: creators.filter((c: any) => c.validDays > 0).length\r\n            }\r\n        };\r\n\r\n        fs.writeFileSync(filePath, JSON.stringify(snapshot, null, 2));\r\n\r\n        return NextResponse.json({ success: true, date: snapshotDate });\r\n    } catch (err) {\r\n        console.error('Failed to save snapshot:', err);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function GET(req: Request) {\r\n    try {\r\n        const { searchParams } = new URL(req.url);\r\n        const date = searchParams.get('date');\r\n\r\n        if (date) {\r\n            // Get specific snapshot\r\n            const filePath = path.join(HISTORY_DIR, `${date}.json`);\r\n            if (!fs.existsSync(filePath)) {\r\n                return NextResponse.json({ error: 'Snapshot not found' }, { status: 404 });\r\n            }\r\n            const fileContent = fs.readFileSync(filePath, 'utf-8');\r\n            return NextResponse.json(JSON.parse(fileContent));\r\n        } else {\r\n            // List all snapshots\r\n            const files = fs.readdirSync(HISTORY_DIR)\r\n                .filter(f => f.endsWith('.json'))\r\n                .sort()\r\n                .reverse(); // Newest first\r\n\r\n            const snapshots = files.map(f => {\r\n                const content = JSON.parse(fs.readFileSync(path.join(HISTORY_DIR, f), 'utf-8'));\r\n                return {\r\n                    date: content.date,\r\n                    timestamp: content.timestamp,\r\n                    metrics: content.metrics\r\n                };\r\n            });\r\n\r\n            return NextResponse.json({ snapshots });\r\n        }\r\n    } catch (err) {\r\n        console.error('Failed to list snapshots:', err);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AAEA;;;;;AAEA,MAAM,cAAc,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAErD,0BAA0B;AAC1B,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,cAAc;IAC7B,wGAAE,CAAC,SAAS,CAAC,aAAa;QAAE,WAAW;IAAK;AAChD;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,4BAA4B;QAE7D,IAAI,CAAC,YAAY,CAAC,MAAM,OAAO,CAAC,WAAW;YACvC,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,eAAe,QAAQ,IAAA,wJAAc;QAC3C,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,aAAa,GAAG,aAAa,KAAK,CAAC;QAE9D,MAAM,WAA4B;YAC9B,MAAM;YACN,WAAW,KAAK,GAAG;YACnB,UAAU;YACV,SAAS;gBACL,eAAe,SAAS,MAAM,CAAC,CAAC,KAAa,IAAW,MAAM,CAAC,EAAE,QAAQ,IAAI,CAAC,GAAG;gBACjF,YAAY,SAAS,MAAM,CAAC,CAAC,KAAa,IAAW,MAAM,CAAC,EAAE,SAAS,IAAI,CAAC,GAAG;gBAC/E,gBAAgB,SAAS,MAAM,CAAC,CAAC,IAAW,EAAE,SAAS,GAAG,GAAG,MAAM;YACvE;QACJ;QAEA,wGAAE,CAAC,aAAa,CAAC,UAAU,KAAK,SAAS,CAAC,UAAU,MAAM;QAE1D,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM;QAAa;IACjE,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ;AAEO,eAAe,IAAI,GAAY;IAClC,IAAI;QACA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,OAAO,aAAa,GAAG,CAAC;QAE9B,IAAI,MAAM;YACN,wBAAwB;YACxB,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,aAAa,GAAG,KAAK,KAAK,CAAC;YACtD,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;gBAC1B,OAAO,sKAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAqB,GAAG;oBAAE,QAAQ;gBAAI;YAC5E;YACA,MAAM,cAAc,wGAAE,CAAC,YAAY,CAAC,UAAU;YAC9C,OAAO,sKAAY,CAAC,IAAI,CAAC,KAAK,KAAK,CAAC;QACxC,OAAO;YACH,qBAAqB;YACrB,MAAM,QAAQ,wGAAE,CAAC,WAAW,CAAC,aACxB,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,CAAC,UACvB,IAAI,GACJ,OAAO,IAAI,eAAe;YAE/B,MAAM,YAAY,MAAM,GAAG,CAAC,CAAA;gBACxB,MAAM,UAAU,KAAK,KAAK,CAAC,wGAAE,CAAC,YAAY,CAAC,4GAAI,CAAC,IAAI,CAAC,aAAa,IAAI;gBACtE,OAAO;oBACH,MAAM,QAAQ,IAAI;oBAClB,WAAW,QAAQ,SAAS;oBAC5B,SAAS,QAAQ,OAAO;gBAC5B;YACJ;YAEA,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE;YAAU;QACzC;IACJ,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}