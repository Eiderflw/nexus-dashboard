{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Eiderflw/Desktop/API%20DIAN/EXCEL/nexus-dashboard/app/api/scraper/search-lives/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { spawn } from 'child_process';\r\nimport path from 'path';\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { keyword, cookie } = await req.json();\r\n\r\n        if (!keyword) {\r\n            return NextResponse.json({ error: 'Falta la palabra clave (keyword)' }, { status: 400 });\r\n        }\r\n\r\n        const scriptPath = path.join(process.cwd(), 'scripts', 'search-lives.js');\r\n\r\n        return new Promise((resolve) => {\r\n            const child = spawn('node', [scriptPath, keyword, cookie || '']);\r\n\r\n            let stdout = '';\r\n            let stderr = '';\r\n\r\n            child.stdout.on('data', (data) => {\r\n                stdout += data.toString();\r\n            });\r\n\r\n            child.stderr.on('data', (data) => {\r\n                stderr += data.toString();\r\n            });\r\n\r\n            child.on('close', (code) => {\r\n                if (code !== 0) {\r\n                    console.error('Search Script Error:', stderr);\r\n                    resolve(NextResponse.json({ error: 'Error ejecutando la búsqueda', details: stderr }, { status: 500 }));\r\n                } else {\r\n                    try {\r\n                        // Robust Parsing: Look for the last valid JSON object in stdout\r\n                        // This ignores any previous console.log noise\r\n                        const lines = stdout.trim().split('\\n');\r\n                        let result = null;\r\n\r\n                        // Try parsing from the last line backwards\r\n                        for (let i = lines.length - 1; i >= 0; i--) {\r\n                            try {\r\n                                const potentialJson = JSON.parse(lines[i]);\r\n                                if (potentialJson && (potentialJson.creators || potentialJson.error)) {\r\n                                    result = potentialJson;\r\n                                    break;\r\n                                }\r\n                            } catch (e) {\r\n                                // Not JSON, continue\r\n                            }\r\n                        }\r\n\r\n                        if (!result) {\r\n                            // Fallback: try parsing the whole thing if it's a single blob\r\n                            result = JSON.parse(stdout);\r\n                        }\r\n\r\n                        if (result.error) {\r\n                            resolve(NextResponse.json({ error: result.error }, { status: 500 }));\r\n                        } else {\r\n                            resolve(NextResponse.json(result));\r\n                        }\r\n                    } catch (e) {\r\n                        console.error('Parse Error:', e, stdout);\r\n                        resolve(NextResponse.json({ error: 'Error analizando respuesta de búsqueda', details: stdout }, { status: 500 }));\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('Search Proxy Error:', error);\r\n        return NextResponse.json({ error: 'Error interno del servidor', details: error.message }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,GAAgB;IACvC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QAE1C,IAAI,CAAC,SAAS;YACV,OAAO,sKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,WAAW;QAEvD,OAAO,IAAI,QAAQ,CAAC;YAChB,MAAM,QAAQ,IAAA,4HAAK,EAAC,QAAQ;gBAAC;gBAAY;gBAAS,UAAU;aAAG;YAE/D,IAAI,SAAS;YACb,IAAI,SAAS;YAEb,MAAM,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;gBACrB,UAAU,KAAK,QAAQ;YAC3B;YAEA,MAAM,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;gBACrB,UAAU,KAAK,QAAQ;YAC3B;YAEA,MAAM,EAAE,CAAC,SAAS,CAAC;gBACf,IAAI,SAAS,GAAG;oBACZ,QAAQ,KAAK,CAAC,wBAAwB;oBACtC,QAAQ,sKAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;wBAAgC,SAAS;oBAAO,GAAG;wBAAE,QAAQ;oBAAI;gBACxG,OAAO;oBACH,IAAI;wBACA,gEAAgE;wBAChE,8CAA8C;wBAC9C,MAAM,QAAQ,OAAO,IAAI,GAAG,KAAK,CAAC;wBAClC,IAAI,SAAS;wBAEb,2CAA2C;wBAC3C,IAAK,IAAI,IAAI,MAAM,MAAM,GAAG,GAAG,KAAK,GAAG,IAAK;4BACxC,IAAI;gCACA,MAAM,gBAAgB,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;gCACzC,IAAI,iBAAiB,CAAC,cAAc,QAAQ,IAAI,cAAc,KAAK,GAAG;oCAClE,SAAS;oCACT;gCACJ;4BACJ,EAAE,OAAO,GAAG;4BACR,qBAAqB;4BACzB;wBACJ;wBAEA,IAAI,CAAC,QAAQ;4BACT,8DAA8D;4BAC9D,SAAS,KAAK,KAAK,CAAC;wBACxB;wBAEA,IAAI,OAAO,KAAK,EAAE;4BACd,QAAQ,sKAAY,CAAC,IAAI,CAAC;gCAAE,OAAO,OAAO,KAAK;4BAAC,GAAG;gCAAE,QAAQ;4BAAI;wBACrE,OAAO;4BACH,QAAQ,sKAAY,CAAC,IAAI,CAAC;wBAC9B;oBACJ,EAAE,OAAO,GAAG;wBACR,QAAQ,KAAK,CAAC,gBAAgB,GAAG;wBACjC,QAAQ,sKAAY,CAAC,IAAI,CAAC;4BAAE,OAAO;4BAA0C,SAAS;wBAAO,GAAG;4BAAE,QAAQ;wBAAI;oBAClH;gBACJ;YACJ;QACJ;IAEJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAA8B,SAAS,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IAC5G;AACJ"}}]
}