{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Eiderflw/Desktop/API%20DIAN/EXCEL/nexus-dashboard/app/api/scraper/manager/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport axios from 'axios';\r\n\r\nconst STATE_FILE = path.join(process.cwd(), 'scraper-state.json');\r\nconst PHOTOS_DIR = path.join(process.cwd(), 'public', 'foto_perfil');\r\n\r\n// --- USER AGENT ROTATION POOL ---\r\nconst USER_AGENTS = [\r\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\r\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',\r\n    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\r\n    'Mozilla/5.0 (iPhone; CPU iPhone OS 17_1_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1.2 Mobile/15E148 Safari/604.1',\r\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0'\r\n];\r\n\r\nconst getHeaders = () => ({\r\n    'User-Agent': USER_AGENTS[Math.floor(Math.random() * USER_AGENTS.length)],\r\n    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\r\n    'Accept-Language': 'en-US,en;q=0.5',\r\n    'Referer': 'https://www.google.com/',\r\n    'Connection': 'keep-alive'\r\n});\r\n\r\n// --- DATA STRUCTURES ---\r\ninterface ScraperState {\r\n    isRunning: boolean;\r\n    queue: string[];\r\n    currentIndex: number;\r\n    total: number;\r\n    successCount: number;\r\n    errorCount: number;\r\n    currentUsername: string;\r\n    lastUpdated: number;\r\n    errorLogs?: Record<string, string>;\r\n}\r\n\r\n// --- HELPER FUNCTIONS ---\r\nfunction loadState(): ScraperState {\r\n    if (fs.existsSync(STATE_FILE)) {\r\n        try {\r\n            const data = JSON.parse(fs.readFileSync(STATE_FILE, 'utf-8'));\r\n            if (!data.errorLogs) data.errorLogs = {};\r\n            return data;\r\n        } catch (e) { console.error(\"Error reading state\", e); }\r\n    }\r\n    return { isRunning: false, queue: [], currentIndex: 0, total: 0, successCount: 0, errorCount: 0, currentUsername: '', lastUpdated: Date.now(), errorLogs: {} };\r\n}\r\n\r\nfunction saveState(state: ScraperState) {\r\n    fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2));\r\n}\r\n\r\n// --- BACKGROUND WORKER ---\r\nlet isWorkerRunning = false;\r\n\r\nasync function runBackgroundWorker() {\r\n    if (isWorkerRunning) return;\r\n    isWorkerRunning = true;\r\n    console.log(\"üöÄ Background Scraper Started (V5 - UA Rotation)\");\r\n\r\n    try {\r\n        while (true) {\r\n            let state = loadState();\r\n\r\n            if (!state.isRunning) break;\r\n            if (state.currentIndex >= state.total) {\r\n                state.isRunning = false;\r\n                saveState(state);\r\n                break;\r\n            }\r\n\r\n            const username = state.queue[state.currentIndex];\r\n            state.currentUsername = username;\r\n            saveState(state);\r\n\r\n            try {\r\n                const result = await scrapePhoto(username);\r\n                state = loadState();\r\n                if (result.success) {\r\n                    state.successCount++;\r\n                    if (state.errorLogs?.[username]) delete state.errorLogs[username];\r\n                } else {\r\n                    state.errorCount++;\r\n                    if (!state.errorLogs) state.errorLogs = {};\r\n                    state.errorLogs[username] = result.error || 'Fallo desconocido';\r\n                }\r\n            } catch (e) {\r\n                state = loadState();\r\n                state.errorCount++;\r\n                if (!state.errorLogs) state.errorLogs = {};\r\n                state.errorLogs[username] = 'Error t√©cnico de red';\r\n            }\r\n\r\n            state.currentIndex++;\r\n            state.lastUpdated = Date.now();\r\n            saveState(state);\r\n\r\n            // Wait between 3 and 7 seconds (Anti-Bot)\r\n            const waitTime = 3000 + Math.random() * 4000;\r\n            await new Promise(r => setTimeout(r, waitTime));\r\n        }\r\n    } finally {\r\n        isWorkerRunning = false;\r\n    }\r\n}\r\n\r\n// --- SCRAPING LOGIC ---\r\nasync function scrapePhoto(username: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        const safeUsername = username.replace(/[^a-zA-Z0-9_\\.]/g, '');\r\n        const imagePath = path.join(PHOTOS_DIR, `${safeUsername}.jpg`);\r\n\r\n        if (!fs.existsSync(PHOTOS_DIR)) fs.mkdirSync(PHOTOS_DIR, { recursive: true });\r\n\r\n        let imageUrl = '';\r\n        let lastError = '';\r\n\r\n        // 1. TikTok Direct (Modern Rehydration)\r\n        try {\r\n            const url = `https://www.tiktok.com/@${username}`;\r\n            const response = await axios.get(url, { headers: getHeaders(), timeout: 12000 });\r\n            const scriptMatch = response.data.match(/<script id=\"__UNIVERSAL_DATA_FOR_REHYDRATION__\" type=\"application\\/json\">(.*?)<\\/script>/);\r\n            if (scriptMatch) {\r\n                const jsonData = JSON.parse(scriptMatch[1]);\r\n                const user = jsonData?.__DEFAULT_SCOPE__?.['webapp.user-detail']?.userInfo?.user;\r\n                if (user) {\r\n                    imageUrl = user.avatarLarger || user.avatarMedium;\r\n                } else {\r\n                    lastError = \"TikTok: Usuario no encontrado/privado\";\r\n                }\r\n            } else {\r\n                lastError = \"TikTok: Bloqueo de seguridad (Bot Detect)\";\r\n            }\r\n        } catch (e) {\r\n            lastError = \"TikTok: Acceso denegado (Rate Limit)\";\r\n        }\r\n\r\n        // 2. Mirror Fallback (Urlebird)\r\n        if (!imageUrl) {\r\n            try {\r\n                const response = await axios.get(`https://urlebird.com/user/${username}/`, { headers: getHeaders(), timeout: 8000 });\r\n                const match = response.data.match(/src=\"([^\"]+)\" class=\"[^\"]*rounded-circle[^\"]*\"/);\r\n                if (match) {\r\n                    imageUrl = match[1];\r\n                } else {\r\n                    lastError = \"Metodos 1 y 2 fallaron (Bloqueo total)\";\r\n                }\r\n            } catch (e) {\r\n                lastError = \"Mirror bloqueado por TikTok\";\r\n            }\r\n        }\r\n\r\n        // 3. Final Fallback: TikTok Embed (Metadata)\r\n        if (!imageUrl) {\r\n            try {\r\n                const response = await axios.get(`https://www.tiktok.com/embed/@${username}`, { headers: getHeaders(), timeout: 8000 });\r\n                const match = response.data.match(/\"avatarLarger\":\"([^\"]+)\"/);\r\n                if (match) {\r\n                    imageUrl = JSON.parse(`\"${match[1]}\"`);\r\n                }\r\n            } catch (e) { }\r\n        }\r\n\r\n        if (imageUrl) {\r\n            try {\r\n                const imgRes = await axios.get(imageUrl, {\r\n                    responseType: 'arraybuffer',\r\n                    headers: { ...getHeaders(), 'Referer': 'https://www.tiktok.com/' }\r\n                });\r\n                fs.writeFileSync(imagePath, imgRes.data);\r\n                return { success: true };\r\n            } catch (e) {\r\n                return { success: false, error: \"Error de descarga (CDN bloqueado)\" };\r\n            }\r\n        }\r\n\r\n        return { success: false, error: lastError || \"Protecci√≥n de TikTok activa\" };\r\n\r\n    } catch (e) {\r\n        return { success: false, error: \"Error en el sistema de sincronizaci√≥n\" };\r\n    }\r\n}\r\n\r\n// --- API HANDLERS ---\r\nexport async function GET() {\r\n    const state = loadState();\r\n    if (state.isRunning && !isWorkerRunning && state.currentIndex < state.total) {\r\n        runBackgroundWorker();\r\n    }\r\n    return NextResponse.json(state);\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n    const body = await request.json();\r\n    const state = loadState();\r\n\r\n    if (body.action === 'start') {\r\n        saveState({\r\n            isRunning: true, queue: body.usernames, currentIndex: 0, total: body.usernames.length,\r\n            successCount: 0, errorCount: 0, currentUsername: '', lastUpdated: Date.now(), errorLogs: {}\r\n        });\r\n        runBackgroundWorker();\r\n        return NextResponse.json({ success: true });\r\n    }\r\n\r\n    if (body.action === 'stop') state.isRunning = false;\r\n    if (body.action === 'resume') state.isRunning = true;\r\n    if (body.action === 'reset') {\r\n        Object.assign(state, { isRunning: false, queue: [], currentIndex: 0, total: 0, successCount: 0, errorCount: 0, currentUsername: '', errorLogs: {} });\r\n    }\r\n\r\n    saveState(state);\r\n    if (body.action === 'resume') runBackgroundWorker();\r\n    return NextResponse.json({ success: true });\r\n}\r\n"],"names":[],"mappings":"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"}}]
}